<head>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <style>
    .country {
      fill: #374359;
    }

    .outline {
      stroke: #95989f;
      stroke-width: 1px;
      fill: none;
    }

    #incomeSlider {
      width: 250px;
    }
  </style>
</head>
<div>
  <div class="container">
    <h3>Select by type</h3>
    <a href="#" class="button" id="case" style="font-size: 20px">Case</a>
    <a href="#" class="button button2" id="death" style="font-size: 20px">Death</a>
    <a href="#" class="button button3" id="vaccination" style="font-size: 20px">vaccination</a>
    <input type="range" min="0" max="701" value="0" class="slider" id="timeSlider" width: "50px">
  </div>
  <div id="main" height="700" width="1400"></div>

  <body>
    <script>
      const main = d3.select("div#main");

      //find width and height of window
      const docWidth =
        window.innerWidth ||
        document.documentElement.clientWidth ||
        document.body.clientWidth;
      const docHeight =
        window.innerHeight ||
        document.documentElement.clientHeight ||
        document.body.clientHeight;

      //create graph dimensions
      const svg = main
        .append("svg")
        .attr("width", docWidth * 0.6)
        .attr("height", docHeight)
        .style('background', '#0e151f')
        .style("margin", 0);

      const width = svg.attr("width");
      const height = svg.attr("height");
      margin = 20;
      const mapWidth = width - margin - margin;
      const mapHeight = height - margin - margin;
      const map = svg
        .append("g")
        .attr("transform", "translate(" + 20 + "," + 20 + ")");

      const requestData = async function () {
        // svg
        // .append("rect")
        // .attr("x", 0)
        // .attr("y", 0)
        // .attr("width", width)
        // .attr("height", height)
        // .style("fill", '#2A2C39')
        // ;
        const us_house = await d3.json("./world_countries.topojson");

        var zips = topojson.feature(us_house, us_house.objects["world_countries-world_countries"]);
        var zipsMesh = topojson.mesh(us_house, us_house.objects["world_countries-world_countries"]);
        console.log(zips);

        var projection = d3
          .geoEquirectangular()
          .fitSize([mapWidth, mapHeight], zips);
        var path = d3.geoPath().projection(projection);
        function countryColor(country) {
          console.log(country);
          if (country == "China") {
            return "#0754ed";
          } else {
            return "#ed2607";
          }
        }
        let outcomeSelect = 'case'
        map
          .selectAll("path.country")
          .data(zips.features)
          .join("path")
          .attr("class", "country")
          .attr("note", (d) => d.properties.name)
          //  .style("fill", d => countryColor(d.properties.name))
          .attr("d", path);
        map
          .append("path")
          .datum(zipsMesh)
          .attr("class", "outline")
          .attr("d", path);
        // .attr("stroke", "white")
        // .style("fill", '#374359')
        let dateData = [];
        start_day = new Date('2020-01-01')
        days = 702
        var data = {}
        for (var i = 0; i < days; i++) {
          data[i] = {}
        }
        console.log(data)

        function dateDiffInDays(a, b) {
          // Discard the time and time-zone information.
          const utc1 = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
          const utc2 = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());

          return Math.floor((utc2 - utc1) / (1000 * 60 * 60 * 24));
        }
        d3.csv("./vacc_processed.csv", function (csvdata) {
          // console.log(new Date(csvdata.date))
          const cur_date = new Date(csvdata.date);
          // const diffTime = Math.abs(cur_date - start_day);
          var diffDays = dateDiffInDays(start_day, cur_date)
          country = csvdata.location
          // console.log(data[diffDays])
          // console.log(diffDays)

          data[diffDays][country] = csvdata
          // console.log(cur_date)


        });
        let btnGen = document.getElementById("case");
        btnGen.onclick = function () {
          outcomeSelect = "case";
          console.log("case")
          // emptyList();
          // createCount('gender');
          // reading('gender');
          // pieChart(dict);
          // updateMap();
        };

        let btnPar = document.getElementById("death");
        btnPar.onclick = function () {
          outcomeSelect = "death";
          console.log("death")

          // emptyList();
          // createCount("party");
          // reading("party");
          // pieChart(dict);
          // updateMap();
        };

        let btnRac = document.getElementById("vaccination");
        btnRac.onclick = function () {
          outcomeSelect = "vaccination";
          console.log("vaccination")


          // emptyList();
          // createCount("race");
          // reading("race");
          // pieChart(dict);
          // updateMap();
        };
        location_list = ['Afghanistan', 'Africa', 'Albania', 'Algeria', 'Andorra', 'Angola',
          'Anguilla', 'Antigua and Barbuda', 'Argentina', 'Armenia', 'Aruba',
          'Asia', 'Australia', 'Austria', 'Azerbaijan', 'Bahamas', 'Bahrain',
          'Bangladesh', 'Barbados', 'Belarus', 'Belgium', 'Belize', 'Benin',
          'Bermuda', 'Bhutan', 'Bolivia', 'Bonaire Sint Eustatius and Saba',
          'Bosnia and Herzegovina', 'Botswana', 'Brazil',
          'British Virgin Islands', 'Brunei', 'Bulgaria', 'Burkina Faso',
          'Burundi', 'Cambodia', 'Cameroon', 'Canada', 'Cape Verde',
          'Cayman Islands', 'Central African Republic', 'Chad', 'Chile',
          'China', 'Colombia', 'Comoros', 'Congo', 'Cook Islands',
          'Costa Rica', "Cote d'Ivoire", 'Croatia', 'Cuba', 'Curacao',
          'Cyprus', 'Czechia', 'Democratic Republic of Congo', 'Denmark',
          'Djibouti', 'Dominica', 'Dominican Republic', 'Ecuador', 'Egypt',
          'El Salvador', 'Equatorial Guinea', 'Eritrea', 'Estonia',
          'Eswatini', 'Ethiopia', 'Europe', 'European Union',
          'Faeroe Islands', 'Falkland Islands', 'Fiji', 'Finland', 'France',
          'French Polynesia', 'Gabon', 'Gambia', 'Georgia', 'Germany',
          'Ghana', 'Gibraltar', 'Greece', 'Greenland', 'Grenada',
          'Guatemala', 'Guernsey', 'Guinea', 'Guinea-Bissau', 'Guyana',
          'Haiti', 'High income', 'Honduras', 'Hong Kong', 'Hungary',
          'Iceland', 'India', 'Indonesia', 'International', 'Iran', 'Iraq',
          'Ireland', 'Isle of Man', 'Israel', 'Italy', 'Jamaica', 'Japan',
          'Jersey', 'Jordan', 'Kazakhstan', 'Kenya', 'Kiribati', 'Kosovo',
          'Kuwait', 'Kyrgyzstan', 'Laos', 'Latvia', 'Lebanon', 'Lesotho',
          'Liberia', 'Libya', 'Liechtenstein', 'Lithuania', 'Low income',
          'Lower middle income', 'Luxembourg', 'Macao', 'Madagascar',
          'Malawi', 'Malaysia', 'Maldives', 'Mali', 'Malta',
          'Marshall Islands', 'Mauritania', 'Mauritius', 'Mexico',
          'Micronesia (country)', 'Moldova', 'Monaco', 'Mongolia',
          'Montenegro', 'Montserrat', 'Morocco', 'Mozambique', 'Myanmar',
          'Namibia', 'Nauru', 'Nepal', 'Netherlands', 'New Caledonia',
          'New Zealand', 'Nicaragua', 'Niger', 'Nigeria', 'Niue',
          'North America', 'North Macedonia', 'Northern Cyprus', 'Norway',
          'Oceania', 'Oman', 'Pakistan', 'Palau', 'Palestine', 'Panama',
          'Papua New Guinea', 'Paraguay', 'Peru', 'Philippines', 'Pitcairn',
          'Poland', 'Portugal', 'Qatar', 'Romania', 'Russia', 'Rwanda',
          'Saint Helena', 'Saint Kitts and Nevis', 'Saint Lucia',
          'Saint Vincent and the Grenadines', 'Samoa', 'San Marino',
          'Sao Tome and Principe', 'Saudi Arabia', 'Senegal', 'Serbia',
          'Seychelles', 'Sierra Leone', 'Singapore',
          'Sint Maarten (Dutch part)', 'Slovakia', 'Slovenia',
          'Solomon Islands', 'Somalia', 'South Africa', 'South America',
          'South Korea', 'South Sudan', 'Spain', 'Sri Lanka', 'Sudan',
          'Suriname', 'Sweden', 'Switzerland', 'Syria', 'Taiwan',
          'Tajikistan', 'Tanzania', 'Thailand', 'Timor', 'Togo', 'Tokelau',
          'Tonga', 'Trinidad and Tobago', 'Tunisia', 'Turkey',
          'Turkmenistan', 'Turks and Caicos Islands', 'Tuvalu', 'Uganda',
          'Ukraine', 'United Arab Emirates', 'United Kingdom',
          'United States', 'Upper middle income', 'Uruguay', 'Uzbekistan',
          'Vanuatu', 'Vatican', 'Venezuela', 'Vietnam', 'Wallis and Futuna',
          'World', 'Yemen', 'Zambia', 'Zimbabwe']

        caseColorScale = d3.scaleLog()
          .domain([0.001, 251363.345])
          .range(["#ACE8D4", "#00726A"])
        deathColorScale = d3.scaleLinear()
          .domain([0, 6033.739])
          .range(["#ACE8D4", "#00726A"])
        vaccinationColorScale = d3.scaleLinear()
          .domain([0, 121.53])
          .range(["#ACE8D4", "#00726A"])



        var outcomeFunctions = {
          case: function (d) {
            if (!d.total_cases_per_million) {
              return 'grey'
            }
            return caseColorScale(d.total_cases_per_million);
          },
          death: function (d) {
            if (!d.total_deaths_per_million) {
              return 'grey'
            }
            return deathColorScale(d.total_deaths_per_million);
          },
          vaccination: function (d) {
            if (!d.people_vaccinated_per_hundred) {
              return 'grey'
            }
            return vaccinationColorScale(d.people_vaccinated_per_hundred);
          },
        };
        updateMap = function () {
          let time = Number(document.getElementById("timeSlider").value)
          // cur_data = data[time]['China']
          // if (!cur_data){
          //   console.log('not!!!')
          // }
          // res = outcomeFunctions[outcomeSelect](cur_data)
          // console.log(res)
          // createCount(outcomeSelect);
          map
            .selectAll("path.country")
            .data(zips.features)
            .join("path")
            .style("fill", (d) => {
              cur_data = data[time][d.properties.name]
              if (d.properties.name == 'China') {
                console.log(cur_data)
              }
              if (!cur_data) {
                return "grey"
              }
              else {
                return outcomeFunctions[outcomeSelect](cur_data)

              }
            }
            )
            .on("mouseover", mouseEntersPlot)
            .on("mouseout", mouseLeavesPlot);
          // .style("fill", data[time]['China']
          // )

          //   .on("mouseover", mouseEntersPlot)
          //   .on("mouseout", mouseLeavesPlot);
        };
        document.getElementById("timeSlider").onchange = function () {
          updateMap();
        };
        console.log(data)
        let tooltipWidth = 210;
      let tooltipHeight = 40;

      // At the end of lecture segment, we added this code to do the mouseover outline the "proper" way
      let momesh = map
        .append("path")
        .attr("class", "mouseover outline")
        .attr("d", "");
      let tooltip = map
        .append("g")
        .attr("class", "tooltip")
        .attr("visibility", "hidden");
      tooltip
        .append("rect")
        .attr("fill", "black")
        .attr("opacity", 0.9)
        .attr("x", -tooltipWidth / 2.0)
        .attr("y", 0)
        .attr("width", tooltipWidth)
        .attr("height", tooltipHeight)
        .style("z-index", 9999);
      let txt = tooltip
        .append("text")
        .attr("fill", "white")
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "hanging")
        .attr("x", 0)
        .attr("y", 2);
      let txt2 = tooltip
        .append("text")
        .attr("fill", "white")
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "hanging")
        .attr("x", 0)
        .attr("y", 22);
      function mouseEntersPlot() {
        // Make tooltip visible

        // Find the state SVG element and add stroke
        let country = d3.select(this);
        country_name = country.datum().properties.name;
        let countryID = country.datum().id;
        console.log(countryID);

        // var mo = topojson.mesh(
        //   us_house,
        //   us_house.objects["world_countries-world_countries"],
        //   function (a, b) {
        //     return a.id === countryID || b.id === countryID;
        //   }
        // );
        // console.log(mo);
        // // //  Then apply it to your special mesh that's on top of everything else
        // momesh.datum(mo).attr("d", path);

        // Original version
        country.attr("stroke","white")
             .attr("stroke-width", 1)
             .raise();
        tooltip.style("visibility", "visible").style("z-index", 9999);
        // Using .datum() to recover the data for the state element (because we used a .join() to make it)...
        // ... get the name of the state and count
        console.log(country.datum());

        txt.text(country_name);
        txt2.text("");

        // You can use the geoPath() generator to do all sorts of helpful things
        // let centroid = path.centroid( state.datum() );  // Get the pixel "center" of the state
        let bounds = path.bounds(country.datum()); // Get the pixel boundaries of the state
        // // In both cases here, the geoPath() is parsing the fancy topoJSON data to figure out pixels using the projection

        // Place it at the bottom of the state, centered
        let xPos = (bounds[0][0] + bounds[1][0]) / 2.0;
        let yPos = bounds[1][1] - 15;

        // Transform the <g> group so that everything moves together easily
        tooltip.attr("transform", `translate(${xPos},${yPos})`);

        // To fix the oscillation, we add this in the CSS for .mouseover
      }

      function mouseLeavesPlot() {
        // Hide when you leave a state
        tooltip.style("visibility", "hidden");

        let country = d3.select(this);

         country.attr("stroke","none")
              .attr("stroke-width", 0)
              .lower();
         // }

        // Here we are hiding the mouseover mesh we added at the end of the lecture
        momesh.attr("d", "");
      }
        // map.selectAll(".country")
        //  .style("fill", d => countryColor(d.properties.name));
      };
      
      
      
      requestData();
    </script>
  </body>